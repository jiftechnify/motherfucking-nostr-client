<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Motherfucking Nostr Client</title>
  <script defer src="https://cdn.jsdelivr.net/npm/@nikolat/makibishi@0.1.1"></script>
  <script src="https://unpkg.com/nostr-tools/lib/nostr.bundle.js"></script>
  <script>
    String.prototype.padStart = String.prototype.padStart ? String.prototype.padStart : function(targetLength, padString) {
      targetLength = Math.floor(targetLength) || 0;
      if(targetLength < this.length) return String(this);

      padString = padString ? String(padString) : " ";

      var pad = "";
      var len = targetLength - this.length;
      var i = 0;
      while(pad.length < len) {
          if(!padString[i]) {
              i = 0;
          }
          pad += padString[i];
          i++;
      }

      return pad + String(this).slice(0);
    };
  </script>
  <style>
    html {
      line-height: 1.4;
    }

    ul#timeline {
      padding-left: 0;
    }
    li.event {
      list-style: none;
      word-break: break-all;
    }
    li.event.event-repost {
      background-color: hsl(130, 100%, 95%);
    }

    button#load-more.loading {
      visibility: hidden;
    }

    .nostr-ref {
      background-color: hsl(268, 100%, 98%);
    }

    .pubkey-ref {
      font-weight: bold;
    }
    a.pubkey-ref {
      text-decoration: none;
    }
    a.pubkey-ref:hover {
      text-decoration: underline;
    }

    .pubkey-mention::before {
      content: "@";
    }

    img.custom-emoji {
      vertical-align: middle;
      height: 1.6rem;
    }

    span.repost-prefix {
      font-style: italic;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>
    This is a motherfucking <a href="https://github.com/nostr-protocol/nostr" target="_blank" rel="noreferrer">Nostr</a> client.
    <span class="makibishi" data-allow-anonymous-reaction="true"></span>
  </h1>
  <p>
    And it's fucking perfect, of course.
    Inspired by <a href="http://motherfuckingwebsite.com/" target="_blank" rel="noreferrer">the website</a>.
    View code on <a href="https://github.com/jiftechnify/motherfucking-nostr-client" target="_blank" rel="noreferrer">GitHub</a>.
  </p>

  <label for="relay-url">Relay URL:</label>
  <input id="relay-url" type="text" value="wss://yabu.me">
  <button id="subscribe-relay">Subscribe</button>

  <hr />

  <div>
    <label for="nsec">Secret Key:</label>
    <input id="nsec" type="password" placeholder="nsec1...">
  </div>
  <textarea id="new-post-content" rows="4" cols="50" autocomplete="off" placeholder="What the fuck is up?"></textarea>
  <button id="send-new-post">Post</button>

  <hr />

  <ul id="timeline"></ul>

  <button type="button" id="load-more" class="loading">More fuckin' posts please</button>

  <script>
    function formatTimestamp(date) {
      return String(date.getHours()).padStart(2, "0") + ":" + String(date.getMinutes()).padStart(2, "0") + ":" + String(date.getSeconds()).padStart(2, "0");
    }

    function baseEventView() {
      var li = document.createElement("li");
      li.classList.add("event");
      return li;
    }

    function timestampView(unixtime) {
      var ts = new Date(unixtime * 1000);
      var timeElem = document.createElement("time");
      timeElem.setAttribute("datetime", ts.toISOString());
      timeElem.textContent = "[" + formatTimestamp(ts) + "]";
      return timeElem;
    }

    function pubkeyView(pubkey) {
      var npub = window.NostrTools.nip19.npubEncode(pubkey);

      var a = document.createElement("a");
      a.href = "https://njump.me/" + npub;
      a.target = "_blank";
      a.rel = "noreferrer";
      a.textContent = pubkey.substring(0, 8);

      a.classList.add("pubkey-ref");

      var authorColor = parseInt(pubkey.substring(0, 2), 16) * 360 / 256;
      a.style.color = "hsl(" + authorColor + ", 90%, 45%)";
      return a;
    }

    function metadataView(nostrEv) {
      var view = document.createElement("span");
      view.appendChild(timestampView(nostrEv.created_at));
      view.appendChild(document.createTextNode(" "));
      view.appendChild(pubkeyView(nostrEv.pubkey));
      view.appendChild(document.createTextNode(" > "));
      return view;
    }

    var contentRefPattern = /(https?:\/\/[^\s]+)|(nostr:[\w]+1[ac-hj-np-z02-9]+)|(:[_a-zA-Z0-9]+:)/;  

    function indexOfFirstUnmatchingCloseParen(url) {
      var nest = 0;
      for (var i = 0; i < url.length; i++) {
        var c = url.charAt(i);
        if (c === "(") {
          nest++;
        } else if (c === ")") {
          if (nest <= 0) {
            return i;
          }
          nest--;
        }
      }
      return -1;
    }

    function urlLink(url) {
      var splitIdx = indexOfFirstUnmatchingCloseParen(url);
      var finalUrl = splitIdx === -1 ? url : url.substring(0, splitIdx);
      var rest = splitIdx === -1 ? "" : url.substring(splitIdx);

      var a = document.createElement("a");
      a.href = finalUrl;
      a.target = "_blank";
      a.rel = "noreferrer";
      a.textContent = finalUrl;

      if (rest.length === 0) {
        return a;
      }
      // FIXME: eliminate the auxiliary <span> used to bundle multiple nodes into a single element
      var aux = document.createElement("span");
      var restSpan = document.createElement("span");
      restSpan.textContent = rest;
      aux.appendChild(a);
      aux.appendChild(restSpan);
      return aux;
    }

    function nostrRefLink(nip19Id, idType) {
      var a = document.createElement("a");
      a.href = "https://njump.me/" + nip19Id;
      a.target = "_blank";
      a.rel = "noreferrer";
      a.textContent = "nostr:" + nip19Id.substring(0, idType.length + 8) + "...";
      a.classList.add("nostr-ref");
      return a;
    }
    function pubkeyMention(pubkey) {
      var pubkeyRef = pubkeyView(pubkey);
      pubkeyRef.classList.add("pubkey-mention");
      return pubkeyRef;
    }
    function nostrUri(ref) {
      var nip19Id = ref.substring(6); // trim "nostr:"

      var dec;
      try {
        dec = window.NostrTools.nip19.decode(nip19Id);
      } catch (err) {
        console.error("failed to decode NIP-19 ID:", err);
        return document.createTextNode(ref);
      }

      switch (dec.type) {
        case "npub":
          return pubkeyMention(dec.data);
        case "nprofile":
          return pubkeyMention(dec.data.pubkey);

        default:
          return nostrRefLink(nip19Id, dec.type);
      }
    }

    function customEmoji(shortcode, nostrEv) {
      var emojiName = shortcode.substring(1, shortcode.length - 1);
      for (var i = 0; i < nostrEv.tags.length; i++) {
        var tag = nostrEv.tags[i];
        if (tag[0] === "emoji" && tag[1] === emojiName && typeof tag[2] === "string") {
          var img = document.createElement('img');
          img.src = tag[2];
          img.alt = shortcode;
          img.classList.add("custom-emoji");
          return img;
        }
      }
      return document.createTextNode(shortcode);
    }

    function postEventView(nostrEv) {
      var view = baseEventView();
      view.classList.add("event-post");

      var contentElems = nostrEv.content.split(contentRefPattern)
        .filter(function(s) {
          return s !== undefined && s.length > 0;
        })
        .map(function(s) {
          if (s.indexOf("http") === 0) {
            return urlLink(s);
          } else if (s.indexOf("nostr:") === 0) {
            return nostrUri(s);
          } else if (s.charAt(0) === ":" && s.charAt(s.length - 1) === ":") {
            return customEmoji(s, nostrEv);
          } else {
            return document.createTextNode(s);
          }
        });

      view.appendChild(metadataView(nostrEv));
      contentElems.forEach(function(el) {
        view.appendChild(el);
      });
      return view;
    }

    function repostEventView(nostrEv) {
      var targetPostId;
      var targetPostAuthor;
      for (var i = 0; i < nostrEv.tags.length; i++) {
        var tag = nostrEv.tags[i];
        if (tag[0] === "e" && typeof tag[1] === "string") {
          targetPostId = tag[1];
        }
        if (tag[0] === "p" && typeof tag[1] === "string") {
          targetPostAuthor = tag[1];
        }
        if (targetPostId && targetPostAuthor) {
          break;
        }
      }
      if (targetPostId === undefined) {
        console.error("repost without target post ID:", nostrEv);
        return undefined;
      }

      var view = baseEventView();
      view.classList.add("event-repost");

      var repostPrefix = document.createElement("span");
      repostPrefix.textContent = "RP: ";
      repostPrefix.classList.add("repost-prefix");
      
      var nevent = window.NostrTools.nip19.neventEncode({ id: targetPostId });
      var repostLink = nostrRefLink(nevent, "nevent");

      view.appendChild(metadataView(nostrEv));
      view.appendChild(repostPrefix);
      view.appendChild(repostLink);

      if (targetPostAuthor) {
        view.appendChild(document.createTextNode(" by "));
        view.appendChild(pubkeyView(targetPostAuthor));
      }
      return view;
    }

    var supportedKinds = [1, 6];
    function onEvent(nostrEv, prepend) {
      if (!window.NostrTools.verifyEvent(nostrEv)) {
        console.error("nostr event with invalid signature:", nostrEv);
        return;
      }
      if (supportedKinds.indexOf(nostrEv.kind) === -1) {
        console.error("unsupported kind:", nostrEv.kind);
        return;
      }

      oldestCreatedAt = Math.min(oldestCreatedAt, nostrEv.created_at);

      var eventView;
      switch (nostrEv.kind) {
      case 1:
        eventView = postEventView(nostrEv);
        break;
      case 6:
        eventView = repostEventView(nostrEv);
        break;
      default:
        // unreachable
        return;
      }
      if (eventView === undefined) {
        return;
      }

      if (prepend) {
        timeline.insertBefore(eventView, timeline.firstChild);
      } else {
        timeline.appendChild(eventView);
      }
    }

    function onWSClose() {
      alert("Relay connection closed");
    }

    var MAIN_SUB_ID = "motherfuncking-main-sub";
    var MORE_POSTS_SUB_ID = "motherfuncking-more-posts";

    function isKnownSubId(subId) {
      return subId === MAIN_SUB_ID || subId === MORE_POSTS_SUB_ID;
    }
    function shouldPrependPost(subId, afterEose) {
      return subId === MAIN_SUB_ID && afterEose;
    }

    var relayWS;
    function subscribeRelay(relayUrl) {
      if (relayWS) {
        while (timeline.firstChild) {
          timeline.removeChild(timeline.firstChild);
        }
        relayWS.removeEventListener("close", onWSClose);
        relayWS.close();
      }
      
      try {
        relayWS = new WebSocket(relayUrl);
      } catch (err) {
        console.error("failed to connect to relay:", err);
        alert("Failed to connect to relay:", relayUrl);
        return;
      }

      var afterEose = false;

      relayWS.addEventListener("open", function() {
        relayWS.send(
          JSON.stringify(["REQ", MAIN_SUB_ID, { kinds: [1, 6], limit: 50 }])
        );
      });

      relayWS.addEventListener("message", function(ev) {
        try {
          var r2cMsg = JSON.parse(ev.data);
          switch (r2cMsg[0]) {
          case "EVENT":
            var subId = r2cMsg[1];
            if (!isKnownSubId(subId)) {
              console.error("unknown subId:", subId);
              return;
            }
            onEvent(r2cMsg[2], shouldPrependPost(subId, afterEose));
            break;

          case "EOSE":
            var subId = r2cMsg[1];
            if (subId === MAIN_SUB_ID) {
              afterEose = true;
            }
            loadMoreButton.classList.remove("loading");
            break;
            
          default:
            console.log(r2cMsg);
            break;
          }
        } catch (err) {
          console.error(err);
        }
      });

      relayWS.addEventListener("close", onWSClose);
    }

    var timeline = document.getElementById("timeline");
    if (timeline === null) {
      throw new Error("no #timeline");
    }

    // subscribing relay
    var relayUrlInput = document.getElementById("relay-url");
    var subscribeButton = document.getElementById("subscribe-relay");
    subscribeButton.addEventListener("click", function() {
      subscribeRelay(relayUrlInput.value);
    });

    // initial subscription
    subscribeRelay(relayUrlInput.value);

    // create new post
    var nsecInput = document.getElementById("nsec");
    var postContentInput = document.getElementById("new-post-content");
    var sendPostButton = document.getElementById("send-new-post");
    function sendeNewPost() {
      var nsec = nsecInput.value;
      var content = postContentInput.value;
      if (!nsec || !content) {
        return;
      }

      try {
        var nsecDecoded = window.NostrTools.nip19.decode(nsec);
        if (nsecDecoded.type !== "nsec") {
          alert("Invalid secret key");
          return;
        }
        var seckey = nsecDecoded.data;
      
        var post = {
          kind: 1,
          content: content,
          created_at: Math.floor(Date.now() / 1000),
          tags: [],
        };
        var signedPost = window.NostrTools.finalizeEvent(post, seckey);
        relayWS.send(JSON.stringify(["EVENT", signedPost]));

        postContentInput.value = "";
      } catch (err) {
        console.error(err);
        alert("Post failed");
      }
    }
    sendPostButton.addEventListener("click", sendeNewPost);
    
    // load more posts
    var oldestCreatedAt = Number.MAX_VALUE;
    var loadMoreButton = document.getElementById("load-more");
    function fetchMorePosts() {
      if (!relayWS) {
        return;
      }
      loadMoreButton.classList.add("loading");
      relayWS.send(
        JSON.stringify(["REQ", MORE_POSTS_SUB_ID, { kinds: [1, 6], limit: 50, until: oldestCreatedAt - 1 }])
      );
    }
    loadMoreButton.addEventListener("click", fetchMorePosts);
  </script>
</body>
</html>